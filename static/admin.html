<!-- admin.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel</title>
  <!-- Prevent caching so Back always reloads and checks auth -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma"        content="no-cache" />
  <meta http-equiv="Expires"       content="0" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .container { max-width: 600px; margin: auto; }
    #status { margin-top: 1em; padding: 0.5em; font-family: sans-serif;
      background: #fffae6; border: 1px solid #ffecb3; border-radius: 4px;
      display: none; }
    #modelList { margin-top: 1em; padding-left: 1.2em; font-family: monospace; }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body>
  <nav class="nav">
    <button id="logoutBtn">Logout</button>
  </nav>

  <div class="container">
    <h1>Train New Model</h1>
    <form id="trainForm">
      <label>
        Model Name:
        <input type="text" name="model_name" placeholder="e.g. CrisisDetectorâ€‘v1" required />
      </label>
      <br/>
      <input type="file" name="zip_file" accept=".zip" required />
      <select name="classifier">
        <option value="svm">SVM</option>
        <option value="iforest">Isolation Forest</option>
        <option value="deep_one_class">Deep One Class Classification (Autoencoder)</option>
        <option value="eif">Extended Isolation Forest</option>
      </select>
      <button type="submit">Train</button>
    </form>

    <div id="status">ðŸš€ Model training in progressâ€¦</div>

    <h2>All Trained Models</h2>
    <ul id="modelList"></ul>
  </div>

  <script>
    const API = 'http://127.0.0.1:8000';
    const token = localStorage.getItem('token');
    if (!token) window.location.replace('login.html');

    // Logout clears token and replaces history
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.replace('login.html');
    });

    const statusEl  = document.getElementById('status');
    const submitBtn = document.querySelector('#trainForm button[type=submit]');

    async function loadModels() {
      const res = await fetch(`${API}/models`, { headers: { 'Authorization': 'Bearer ' + token } });
      const models = await res.json();
      const ul = document.getElementById('modelList');
      ul.innerHTML = '';
      models.forEach(m => {
        const li = document.createElement('li');
        const when = new Date(m.training_date).toLocaleString();
        li.textContent = `${m.id}: ${m.name} (${m.classifier}) â€” trained at ${when}`;
        ul.appendChild(li);
      });
    }

    async function pollJob(jobId) {
      const res = await fetch(`${API}/training_jobs/${jobId}`, { headers: { 'Authorization': 'Bearer ' + token } });
      const js = await res.json();
      if (js.status === 'pending' || js.status === 'running') {
        setTimeout(() => pollJob(jobId), 2000);
      } else {
        statusEl.style.display = 'none';
        submitBtn.disabled = false;
        await loadModels();
      }
    }

    document.getElementById('trainForm').onsubmit = async e => {
      e.preventDefault();
      statusEl.style.display = 'block';
      submitBtn.disabled = true;
      try {
        const res = await fetch(`${API}/models/train`, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: new FormData(e.target)
        });
        if (!res.ok) throw new Error(await res.text() || res.statusText);
        const { job_id } = await res.json();
        pollJob(job_id);
      } catch (err) {
        console.error('Training start failed:', err);
        statusEl.style.display = 'none';
        submitBtn.disabled = false;
      }
    };

    window.addEventListener('DOMContentLoaded', loadModels);
  </script>
</body>
</html>